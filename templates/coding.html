<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroPrep - Coding Round</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/coding.css') }}">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        .problem-section {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .editor-section {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .CodeMirror {
            flex: 1;
            height: 100% !important;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #runBtn {
            background-color: #2ecc71;
            color: white;
        }
        #runBtn:hover {
            background-color: #27ae60;
        }
        #submitBtn {
            background-color: #3498db;
            color: white;
        }
        #submitBtn:hover {
            background-color: #2980b9;
        }
        .timer {
            text-align: right;
            margin-bottom: 10px;
            color: #666;
        }
        .language-select {
            margin-bottom: 10px;
        }
        select {
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .test-cases {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .test-case {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
            color: #333;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .test-case.passed {
            border-color: #2ecc71;
            background-color: #f0fff4;
        }
        .test-case.failed {
            border-color: #e74c3c;
            background-color: #fff5f5;
        }
        .test-case-content {
            margin-top: 5px;
            padding: 5px;
            background-color: #fff;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #333;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .test-case-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        .problem-header {
            margin-bottom: 20px;
        }
        .problem-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        .problem-content pre {
            position: relative;
            background: #282c34;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .problem-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            color: #abb2bf;
        }
        .problem-content code {
            background: #f8f9fa;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 5px 10px;
            background: #4a4a4a;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .problem-content pre:hover .copy-button {
            opacity: 1;
        }
        .copy-button:hover {
            background: #666;
        }
        .copy-button.copied {
            background: #2ecc71;
        }
        .difficulty-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .difficulty-easy {
            background: #2ecc71;
            color: white;
        }
        .difficulty-medium {
            background: #f1c40f;
            color: black;
        }
        .difficulty-hard {
            background: #e74c3c;
            color: white;
        }
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .editor-actions {
            display: flex;
            gap: 5px;
        }
        .editor-actions button {
            padding: 5px 10px;
            font-size: 12px;
            background: #f0f0f0;
            color: #333;
        }
        .editor-actions button:hover {
            background: #e0e0e0;
        }
        .keyboard-shortcuts {
            font-size: 12px;
            color: #666;
        }
        .keyboard-shortcut {
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            margin: 0 2px;
        }
        .test-summary {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-summary span {
            font-weight: bold;
        }
        .test-summary .passed {
            color: #2ecc71;
        }
        .test-summary .failed {
            color: #e74c3c;
        }
        .problem-title {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .problem-difficulty {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .problem-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-message {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
        .error-message {
            background: #fff5f5;
            color: #e74c3c;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .success-message {
            background: #f0fff4;
            color: #2ecc71;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .keyboard-shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
        }
        .keyboard-shortcuts.show {
            display: block;
        }
        .keyboard-shortcut {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 5px;
            border-radius: 3px;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="problem-section">
            <div class="problem-header">
                <h1 class="problem-title" id="problemTitle"></h1>
                <span class="difficulty-badge" id="difficultyBadge"></span>
                <div class="problem-stats">
                    <span id="acceptanceRate"></span>
                    <span id="submissions"></span>
                </div>
            </div>
            <div class="problem-content" id="problemContent"></div>
        </div>
        <div class="editor-section">
            <div class="editor-toolbar">
                <select id="languageSelect" class="language-select">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="java">Java</option>
                </select>
                <div class="editor-actions">
                    <button onclick="resetCode()">Reset Code</button>
                    <button onclick="formatCode()">Format Code</button>
                </div>
            </div>
            <div class="editor-container">
                <textarea id="codeEditor"></textarea>
            </div>
            <div class="test-cases" id="testCases">
                <div class="test-summary" id="testSummary" style="display: none;">
                    <span>Test Results:</span>
                    <span class="passed" id="passedTests">0 passed</span>
                    <span class="failed" id="failedTests">0 failed</span>
                </div>
                <div id="testResults"></div>
            </div>
            <div class="controls">
                <button id="runBtn" onclick="runCode()">Run Code</button>
                <button id="submitBtn" onclick="submitCode()">Submit</button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-message" id="loadingMessage">Processing...</div>
        </div>
    </div>
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>
    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <div>Keyboard Shortcuts:</div>
        <span class="keyboard-shortcut">Ctrl+S</span> Save
        <span class="keyboard-shortcut">Ctrl+R</span> Run
        <span class="keyboard-shortcut">Ctrl+Enter</span> Submit
        <span class="keyboard-shortcut">Ctrl+F</span> Format
        <span class="keyboard-shortcut">Esc</span> Close
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-java.min.js"></script>

    <script>
        let editor;
        let currentQuestion;
        let starterCode = {};
        let autoSaveInterval;
        let lastSavedCode = '';

        // Initialize CodeMirror editor
        document.addEventListener('DOMContentLoaded', function() {
            editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                tabSize: 4,
                lineWrapping: true,
                viewportMargin: Infinity,
                extraKeys: {
                    "Ctrl-S": function(cm) { saveCode(); },
                    "Ctrl-R": function(cm) { runCode(); },
                    "Ctrl-Enter": function(cm) { submitCode(); },
                    "Ctrl-F": function(cm) { formatCode(); },
                    "Esc": function(cm) { toggleKeyboardShortcuts(); }
                }
            });

            // Load first question
            loadQuestion();

            // Set up language change handler
            document.getElementById('languageSelect').addEventListener('change', function(e) {
                const language = e.target.value;
                updateEditorMode(language);
                resetCode();
            });

            // Set up auto-save
            setupAutoSave();

            // Set up keyboard shortcuts help
            document.addEventListener('keydown', function(e) {
                if (e.key === '?') {
                    toggleKeyboardShortcuts();
                }
            });
        });

        function setupAutoSave() {
            autoSaveInterval = setInterval(() => {
                const currentCode = editor.getValue();
                if (currentCode !== lastSavedCode) {
                    saveCode();
                    lastSavedCode = currentCode;
                }
            }, 30000); // Auto-save every 30 seconds
        }

        function saveCode() {
            const code = editor.getValue();
            localStorage.setItem('lastSavedCode', code);
            showMessage('Code saved successfully', 'success');
        }

        function showMessage(message, type) {
            const messageElement = document.getElementById(type === 'error' ? 'errorMessage' : 'successMessage');
            messageElement.textContent = message;
            messageElement.style.display = 'block';
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function toggleKeyboardShortcuts() {
            const shortcuts = document.getElementById('keyboardShortcuts');
            shortcuts.classList.toggle('show');
        }

        function formatCode() {
            const language = document.getElementById('languageSelect').value;
            const code = editor.getValue();
            
            showLoading('Formatting code...');
            
            fetch('/format-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    language: language
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    editor.setValue(data.formatted_code);
                    showMessage('Code formatted successfully', 'success');
                } else {
                    showMessage('Error formatting code: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to format code', 'error');
            })
            .finally(() => {
                hideLoading();
            });
        }

        function runCode() {
            const language = document.getElementById('languageSelect').value;
            const code = editor.getValue();
            
            showLoading('Running code...');
            
            // Disable buttons during execution
            document.getElementById('runBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            
            fetch('/run-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    language: language,
                    question_id: currentQuestion.id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTestResults(data.results);
                } else {
                    showMessage('Error running code: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to run code', 'error');
            })
            .finally(() => {
                // Re-enable buttons
                document.getElementById('runBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                hideLoading();
            });
        }

        function submitCode() {
            const language = document.getElementById('languageSelect').value;
            const code = editor.getValue();
            
            showLoading('Submitting code...');
            
            // Disable buttons during submission
            document.getElementById('runBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            
            fetch('/submit-coding', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    language: language,
                    question_id: currentQuestion.id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.completed) {
                        window.location.href = '/hr';
                    } else {
                        loadQuestion();
                    }
                } else {
                    showMessage('Error submitting code: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to submit code', 'error');
            })
            .finally(() => {
                // Re-enable buttons
                document.getElementById('runBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                hideLoading();
            });
        }

        function displayTestResults(results) {
            const testResultsDiv = document.getElementById('testResults');
            const testSummary = document.getElementById('testSummary');
            testResultsDiv.innerHTML = '';
            
            let passedCount = 0;
            let failedCount = 0;
            
            results.forEach((result, index) => {
                const testCase = document.createElement('div');
                testCase.className = `test-case ${result.passed ? 'passed' : 'failed'}`;
                
                const header = document.createElement('div');
                header.className = 'test-case-header';
                header.textContent = `Test Case ${index + 1}: ${result.passed ? 'Passed' : 'Failed'}`;
                
                const content = document.createElement('div');
                content.className = 'test-case-content';
                if (result.passed) {
                    content.textContent = `Output: ${result.output}`;
                    passedCount++;
                } else {
                    content.textContent = `Error: ${result.error}`;
                    failedCount++;
                }
                
                testCase.appendChild(header);
                testCase.appendChild(content);
                testResultsDiv.appendChild(testCase);
            });
            
            // Update summary
            document.getElementById('passedTests').textContent = `${passedCount} passed`;
            document.getElementById('failedTests').textContent = `${failedCount} failed`;
            testSummary.style.display = 'flex';
        }

        function updateEditorMode(language) {
            const modeMap = {
                'python': 'python',
                'javascript': 'javascript',
                'java': 'text/x-java'
            };
            editor.setOption('mode', modeMap[language]);
        }

        function loadQuestion() {
            fetch('/get-coding-question')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentQuestion = data.question;
                        starterCode = data.question.starter_code;
                        
                        // Update UI
                        document.getElementById('problemTitle').textContent = data.question.title;
                        document.getElementById('difficultyBadge').textContent = data.question.difficulty;
                        document.getElementById('difficultyBadge').className = `difficulty-badge difficulty-${data.question.difficulty.toLowerCase()}`;
                        
                        // Update stats
                        document.getElementById('acceptanceRate').textContent = `Acceptance Rate: ${Math.round(data.question.acceptance_rate)}%`;
                        document.getElementById('submissions').textContent = `Total Submissions: ${data.question.total_submissions.toLocaleString()}`;
                        
                        // Render problem content with Markdown
                        document.getElementById('problemContent').innerHTML = marked.parse(data.question.content);
                        
                        // Reset editor with starter code
                        resetCode();
                        
                        // Clear test results
                        document.getElementById('testResults').innerHTML = '';
                        document.getElementById('testSummary').style.display = 'none';
                        
                        // Highlight code blocks
                        Prism.highlightAll();
                    } else {
                        alert('Failed to load question: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load question');
                });
        }

        function resetCode() {
            const language = document.getElementById('languageSelect').value;
            editor.setValue(starterCode[language] || '');
        }
    </script>
</body>
</html> 