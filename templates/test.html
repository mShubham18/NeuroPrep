<script>
    let userName = "Candidate";
    let roundType = "introduction";

    async function startVoiceInteraction() {
        console.log("ğŸ”¹ Voice interaction started...");

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.lang = "en-US";

        function speak(text) {
            console.log("ğŸ”¹ Speaking:", text);

            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);

            utterance.onend = () => {
                console.log("ğŸ”¹ Finished speaking, waiting for response...");
                recognition.start();
            };
        }

        async function askQuestion() {
            console.log("ğŸ”¹ Fetching AI response...");
            
            try {
                const aiResponse = await fetch("/ai-response", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user: userName, round: roundType }),
                });

                const data = await aiResponse.json();
                console.log("ğŸ”¹ AI Response:", data);

                if (data.reply) {
                    speak(data.reply);
                }

                if (data.reply.includes("Please proceed")) {
                    alert("Round finished!");
                    return;
                }
            } catch (error) {
                console.error("âŒ Error fetching AI response:", error);
            }
        }

        recognition.onresult = async function (event) {
            let userResponse = event.results[0][0].transcript;
            console.log("ğŸ¤ User said:", userResponse);
            askQuestion();
        };

        recognition.onerror = function (event) {
            console.error("âŒ Speech recognition error:", event.error);
        };

        askQuestion();
    }

    window.onload = function () {
        console.log("ğŸ”¹ Page loaded. Starting interaction...");
        startVoiceInteraction();
    };
</script>
